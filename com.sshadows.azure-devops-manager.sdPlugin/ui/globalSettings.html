<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Azure DevOps Manager Settings</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #E2E2E2;
            margin: 0;
            padding: 8px;
            user-select: none;
        }

        .sdpi-wrapper {
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .sdpi-item {
            margin-bottom: 12px;
        }

        .sdpi-heading {
            padding: 8px 0;
            font-weight: bold;
        }

        .sdpi-item-label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .sdpi-item-value {
            display: flex;
            align-items: center;
        }

        select, input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #3D3D3D;
            color: #E2E2E2;
            font-size: 12px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #77F;
        }

        .info-text {
            font-size: 11px;
            color: #AAA;
            margin-top: 4px;
        }

        .success-text {
            font-size: 11px;
            color: #7F7;
            margin-top: 4px;
            font-weight: bold;
        }

        .error-text {
            font-size: 11px;
            color: #F77;
            margin-top: 4px;
            font-weight: bold;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: spin 2s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .button {
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #4D4D4D;
            color: #FFF;
            border: none;
            cursor: pointer;
            font-size: 12px;
            margin-top: 12px;
        }

        .button:hover {
            background-color: #5D5D5D;
        }

        .button:active {
            background-color: #3D3D3D;
        }

        .button-primary {
            background-color: #1976D2;
        }

        .button-primary:hover {
            background-color: #2196F3;
        }

        .button-primary:active {
            background-color: #0D47A1;
        }
    </style>
</head>
<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-heading">Azure DevOps Manager Settings</div>
        </div>

        <div class="sdpi-item">
            <label class="sdpi-item-label" for="organizationUrl">Azure DevOps Organization URL</label>
            <div class="sdpi-item-value">
                <input type="text" id="organizationUrl" placeholder="https://dev.azure.com/your-organization">
            </div>
            <div class="info-text">Enter your Azure DevOps organization URL (e.g., https://dev.azure.com/your-organization)</div>
        </div>

        <div class="sdpi-item">
            <label class="sdpi-item-label" for="personalAccessToken">Personal Access Token (PAT)</label>
            <div class="sdpi-item-value">
                <input type="password" id="personalAccessToken" placeholder="Enter your PAT">
            </div>
            <div class="info-text">Enter your Azure DevOps Personal Access Token with the following scopes: 'Build (read)' and 'Code (read)'</div>
        </div>

        <div class="sdpi-item">
            <button id="saveSettings" class="button button-primary">Save Settings</button>
            <button id="testConnection" class="button">Test Connection</button>
        </div>

        <div id="connectionStatus" class="sdpi-item hidden">
            <div id="testSuccess" class="success-text hidden">Successfully connected to Azure DevOps!</div>
            <div id="testError" class="error-text hidden">Failed to connect to Azure DevOps. Please check your settings.</div>
            <div id="testSpinner" class="spinner"></div>
        </div>
    </div>

    <script>
        let websocket = null;
        let pluginUUID = null;
        let globalSettings = null;
        
        // Connect to Stream Deck
        function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
            pluginUUID = inPluginUUID;
            
            // Register with Stream Deck
            websocket = new WebSocket(`ws://127.0.0.1:${inPort}`);
            
            websocket.onopen = function() {
                // WebSocket is connected, register the plugin
                websocket.send(JSON.stringify({
                    event: inRegisterEvent,
                    uuid: inPluginUUID
                }));
                
                // Request global settings
                requestGlobalSettings();
            };
            
            websocket.onmessage = function(evt) {
                const data = JSON.parse(evt.data);
                const event = data.event;
                const payload = data.payload;
                
                if (event === 'didReceiveGlobalSettings') {
                    globalSettings = payload.settings;
                    
                    // Populate form with existing settings
                    populateFormWithSettings();
                } 
                else if (event === 'sendToPropertyInspector') {
                    if (payload.command === 'testConnectionResult') {
                        // Handle test connection result
                        document.getElementById('testSpinner').classList.add('hidden');
                        
                        if (payload.success) {
                            document.getElementById('testSuccess').classList.remove('hidden');
                            document.getElementById('testError').classList.add('hidden');
                        } else {
                            document.getElementById('testSuccess').classList.add('hidden');
                            document.getElementById('testError').classList.remove('hidden');
                        }
                    }
                }
            };
            
            websocket.onclose = function() {
                // WebSocket is closed
                console.log("WebSocket connection closed");
            };
        }
        
        // Request the current global settings
        function requestGlobalSettings() {
            if (websocket) {
                websocket.send(JSON.stringify({
                    event: 'getGlobalSettings',
                    context: pluginUUID
                }));
            }
        }
        
        // Save global settings
        function saveGlobalSettings(settings) {
            if (websocket) {
                websocket.send(JSON.stringify({
                    event: 'setGlobalSettings',
                    context: pluginUUID,
                    payload: settings
                }));
            }
        }
        
        // Populate form with existing settings
        function populateFormWithSettings() {
            if (globalSettings && globalSettings.auth) {
                document.getElementById('organizationUrl').value = globalSettings.auth.organizationUrl || '';
                
                // Only show dots for the PAT if it's already set
                if (globalSettings.auth.personalAccessToken) {
                    document.getElementById('personalAccessToken').value = globalSettings.auth.personalAccessToken;
                }
            }
        }
        
        // Test connection to Azure DevOps
        function testConnection() {
            if (websocket) {
                document.getElementById('connectionStatus').classList.remove('hidden');
                document.getElementById('testSpinner').classList.remove('hidden');
                document.getElementById('testSuccess').classList.add('hidden');
                document.getElementById('testError').classList.add('hidden');
                
                websocket.send(JSON.stringify({
                    event: 'sendToPlugin',
                    action: 'com.sshadows.azure-devops-manager.global-settings',
                    context: pluginUUID,
                    payload: {
                        command: 'testConnection',
                        organizationUrl: document.getElementById('organizationUrl').value,
                        personalAccessToken: document.getElementById('personalAccessToken').value
                    }
                }));
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Save settings button
            document.getElementById('saveSettings').addEventListener('click', function() {
                const organizationUrl = document.getElementById('organizationUrl').value.trim();
                const personalAccessToken = document.getElementById('personalAccessToken').value.trim();
                
                // Create or update global settings object
                if (!globalSettings) {
                    globalSettings = {
                        auth: {
                            organizationUrl: organizationUrl,
                            personalAccessToken: personalAccessToken
                        },
                        projects: [],
                        refreshInterval: 60
                    };
                } else {
                    if (!globalSettings.auth) {
                        globalSettings.auth = {};
                    }
                    
                    globalSettings.auth.organizationUrl = organizationUrl;
                    globalSettings.auth.personalAccessToken = personalAccessToken;
                }
                
                // Save global settings
                saveGlobalSettings(globalSettings);
            });
            
            // Test connection button
            document.getElementById('testConnection').addEventListener('click', function() {
                testConnection();
            });
        });
    </script>
</body>
</html>
